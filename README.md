## FSXX

### 文件系统基本属性

- 该文件系统存储空间大小为 4 G，且以 4k 为一块进行划分
- 在块中又进行如下规划
  - mem[0] 存放文件系统内存空间及其余量信息；
  - mem[1]、mem[2] 存放每个块的占用情况；
  - mem[3]、mem[3 + IBLOCK_NUM] 存放文件占用的第一个块（也即文件的属性块）的块编号，作为文件系统的索引目录；
  - 其余块存放文件内容，且每个文件占用的第一个块存放文件名等文件属性信息，以下叫做数据块；
  - 每个数据块的末尾 sizeof(ull) 长度用于存放该块的的下一块的编号，以将整个文件串起来，前面则用于存放。

### 基本算法实现

- 信息块
  - superblock 只存放文件系统总空间、已用空间、剩余空间大小；
  - bitmap_block 的一个 bit 对应于一块的使用情况；
  - index_block 只存放存在的文件的属性块编号，当编号为 0 时表示文件已阅读完毕。

- 结构体

  - 超级块结构体（总空间、已用空间、剩余空间）；
  - 文件属性结构体（直接将 stat 结构体放入了该结构体）；
  - 文件数据块结构体（由文件内容和下一块的编号组成）。

- 辅助函数

  - mark_block()，标记快的使用情况，已使用标记为 1 ，未使用标记为 0 ，无返回值；
  - find_free()，找到空闲块，每次都从又开始扫描，返回最前面的空闲块编号，当没有空闲块可用时，则返回 0，便于系统返回空间不足的信息，时间复杂度不低；
  - new_block()，对需要的块进行 map，主要用在对文件进行初始化时；
  - creat_block()，先调用 find_free() 函数找到空闲块，对新块进行 map，并调用mark_block() 函数对新使用的块进行标记，更改文件系统元信息；
  - index_add()，增加目录，在目录条目的最后增加；
  - index_delete()，删减目录，将最后一个文件目录项移到该文件目录项所在位置，将原来最后一个文件的目录项设置为 0；
  - search_wrblock()，找到要写或要读的文件的前一个位置，可减少读特殊块的特殊处理，返回该位置所在块的编号，size 编号（也 即坐标信息）；
  - destroy_block()，释放该块即其后关联的块；
  - get_attr_blcok()，根据文件名找到属性块，并返回属性块编号。

- init 函数

  初始化信息块；

- getattr 函数

  找到文件所在的属性块，一一匹配；

- readdir 函数

  将文件目录一一读出；

- mknod 函数

  初始属性设定，增加文件目录；

- open 函数

- write 函数

- truncate 函数

- read 函数

- unlink 函数

### 总结

该文件系统仅仅实现了一些基本功能，还有待完善，由于没有做特殊优化，性能不够高。

